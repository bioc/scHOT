---
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
%\VignetteEngine{knitr::knitr}
  %\VignetteIndexEntry{Getting start: scHOT}
  %\usepackage[UTF-8]{inputenc}
  ---
  
```{r}
library(SingleCellExperiment)
library(scHOT)
```
  
# Spatial data

## Perform scHOT step by step
  
```{r}
load("data/MOB_subset.Rda", verbose = TRUE)
sce_MOB_subset
```

```{r}

scHOT_spatial <- scHOT_buildFromSCE(sce_MOB_subset,
                                    assayName = "counts",
                                    positionType = "spatial",
                                    positionColData = c("x", "y"))
logcounts(scHOT_spatial) <- logcounts(sce_MOB_subset)



pairs <- t(combn(intersect(HVG, nonDEgenes),2))
rownames(pairs) <- apply(pairs,1,paste0,collapse = "_")



set.seed(2020)
pairs <- pairs[sample(nrow(pairs), 10), ]

cat("Pairs to be tested")
pairs <- rbind(pairs, c("Arrb1", "Mtor"))

scHOT_spatial <- scHOT_addTestingScaffold(scHOT_spatial, pairs)

scHOT_spatial <- scHOT_setWeightMatrix(scHOT_spatial,
                                       positionColData = c("x","y"),
                                       positionType = "spatial",
                                       nrow.out = NULL,
                                       span = 0.05)

dim(scHOT_spatial@weightMatrix)

scHOT_spatial <- scHOT_calculateGlobalHigherOrderFunction(scHOT_spatial, 
                                                          higherOrderFunction = weightedSpearman,
                                                          higherOrderFunctionType = "weighted")


scHOT_spatial@scHOT_output

scHOT_spatial <- scHOT_setPermutationScaffold(scHOT_spatial, 
                                              numberPermutations = 100)


scHOT_spatial@scHOT_output


scHOT_spatial <- scHOT_calculateHigherOrderTestStatistics(scHOT_spatial,
                                                          higherOrderSummaryFunction = sd)

scHOT_spatial@scHOT_output




system.time(scHOT_spatial <- scHOT_performPermutationTest(scHOT_spatial, 
                                                          verbose = TRUE,
                                                          parallel = TRUE,
                                                          BPPARAM = MulticoreParam(workers = 4)))





scHOT_spatial <- scHOT_estimatePvalues(scHOT_spatial)
scHOT_spatial@scHOT_output

colData(scHOT_spatial)[, "-x"] <- -colData(scHOT_spatial)[, "x"]
plotHigherOrderSequence(scHOT_spatial, c("Dnm1l_Gucy1b3"),
                        positionColData = c("-x", "y"))

plotOrderedExpression(scHOT_spatial, "Dnm1l_Gucy1b3",
                      positionColData = c("-x", "y"),
                      assayName = "logcounts")


```

## Perform scHOT using `scHOT` wrap-up function

```{r}

scHOT_spatial@scHOT_output <- DataFrame(NULL)

scHOT_spatial <- scHOT(scHOT_spatial,
                       testingScaffold = matrix(c("Arrb1", "Mtor"), 
                                                ncol = 2, byrow = TRUE),
                       positionType = "spatial",
                       positionColData = c("x", "y"),
                       nrow.out = NULL,
                       higherOrderFunction = weightedSpearman,
                       higherOrderFunctionType = 'weighted',
                       numberPermutations = 100,
                       higherOrderSummaryFunction = sd,
                       parallel = TRUE,
                       BPPARAM = MulticoreParam(workers = 4),
                       verbose = TRUE,
                       span = 0.05)



plotOrderedExpression(scHOT_spatial, "Arrb1_Mtor",
                      positionColData = c("-x", "y"),
                      assayName = "logcounts")
plotHigherOrderSequence(scHOT_spatial, "Arrb1_Mtor",
                        positionColData = c("-x", "y"))

```




```{r}
sessionInfo()
```
