---
title: "Getting started: scHOT"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEngine{knitr::knitr}
  %\VignetteIndexEntry{Getting started: scHOT}
  %\usepackage[UTF-8]{inputenc}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  message = FALSE,
  warning = FALSE,
  comment = "#>"
)
```



```{r}
library(SingleCellExperiment)
library(ggplot2)
library(scHOT)
```


# Testing variability changes along liver trajectory

Investigate changes in variability along the first part of the trajectory,
from hepatoblast to the decision point. Using weighted variance as implemented
in the `matrixStats` package.

```{r}
data(liver)
# load("../data/liver.RData", verbose = TRUE)
```


```{r}
first_branch_cells = intersect(colnames(liver_branch_chol),
                               colnames(liver_branch_hep))

gene_to_test <- as.matrix(c("Birc5", "H2afz", "Tacc3"))

# weightedVar2 <- function(w, x) {
#   weightedVar2 <- weightedVar(x, w)
# }
```

## First branch

First we build the `scHOT` object, which is based on the `SingleCellExperiment` 
object. `scHOT` objects can be built either from a matrix format or from an 
existing `SingleCellExperiment` object. 

```{r}
scHOT_traj <- scHOT_buildFromMatrix(
  mat = liver_branch_hep[,first_branch_cells],
  cellData = list(pseudotime = liver_pseudotime_hep[first_branch_cells]),
  positionType = "trajectory",
  positionColData = "pseudotime")
scHOT_traj

scater::plotExpression(scHOT_traj, c("Sall4"),
                       exprs_values = "expression", x = "pseudotime")
```

Now using the `scHOT` wrapper function, we can perform higher order testing on 
the selected genes.

```{r}
scHOT_traj_wrap = scHOT(scHOT_traj,
                        testingScaffold = gene_to_test,
                        higherOrderFunction = matrixStats::weightedVar,
                        higherOrderFunctionType = "weighted",
                        numberScaffold = 100,
                        numberPermutations = 100,
                        higherOrderSummaryFunction = sd,
                        parallel = TRUE,
                        plot = FALSE,
                        BPPARAM = MulticoreParam(workers = 4),
                        verbose = TRUE,
                        span = 0.25)

scHOT_traj_wrap@scHOT_output

scHOT_traj_wrap@scHOT_output$higherOrderSequence

plotHigherOrderSequence(scHOT_traj_wrap, "Tacc3")
```

Now, we can perform the same testing but step-by-step.

```{r}
scHOT_traj <- scHOT_addTestingScaffold(scHOT_traj, gene_to_test)

scHOT_traj <- scHOT_setWeightMatrix(scHOT_traj,
                                    positionColData = c("pseudotime"),
                                    positionType = "trajectory",
                                    nrow.out = NULL,
                                    span = 0.25)

scHOT_traj <- scHOT_calculateGlobalHigherOrderFunction(
  scHOT_traj, 
  higherOrderFunction = matrixStats::weightedVar,
  higherOrderFunctionType = "weighted")


scHOT_traj@scHOT_output

scHOT_traj <- scHOT_setPermutationScaffold(scHOT_traj, 
                                           numberPermutations = 100)


scHOT_traj@scHOT_output


scHOT_traj <- scHOT_calculateHigherOrderTestStatistics(
  scHOT_traj,
  higherOrderSummaryFunction = sd)

scHOT_traj@scHOT_output

system.time(scHOT_traj <- scHOT_performPermutationTest(
  scHOT_traj, 
  verbose = TRUE,
  parallel = TRUE,
  BPPARAM = MulticoreParam(workers = 4)))


scHOT_traj <- scHOT_estimatePvalues(scHOT_traj)
scHOT_traj@scHOT_output

scHOT_traj@scHOT_output$higherOrderSequence

plotHigherOrderSequence(scHOT_traj, "Tacc3")
```

# Spatial differential correlation in Mouse Olfactory Bulb

We load up the Spatial Transcriptomics mouse olfactory bulb data, and build a 
`scHOT` object from the `SingleCellExperiment` object.

```{r}
data(MOB_subset)
# load("../data/MOB_subset.RData", verbose = TRUE)
sce_MOB_subset

scHOT_spatial <- scHOT_buildFromSCE(sce_MOB_subset,
                                    assayName = "logcounts",
                                    positionType = "spatial",
                                    positionColData = c("x", "y"))

scHOT_spatial
```

## Perform scHOT step by step - skip 
[ahead](#perform-schot-using-schot-wrapper-function) for wrapper using `scHOT`

```{r}
pairs <- t(combn(intersect(HVG, nonDEgenes),2))
rownames(pairs) <- apply(pairs,1,paste0,collapse = "_")
head(pairs)

set.seed(2020)
pairs <- pairs[sample(nrow(pairs), 10), ]

cat("Pairs to be tested")
pairs <- rbind(pairs, "Arrb1_Mtor" = c("Arrb1", "Mtor"))

scHOT_spatial <- scHOT_addTestingScaffold(scHOT_spatial, pairs)

scHOT_spatial <- scHOT_setWeightMatrix(scHOT_spatial,
                                       positionColData = c("x","y"),
                                       positionType = "spatial",
                                       nrow.out = NULL,
                                       span = 0.05)

dim(scHOT_spatial@weightMatrix)

scHOT_spatial <- scHOT_calculateGlobalHigherOrderFunction(
  scHOT_spatial, 
  higherOrderFunction = weightedSpearman,
  higherOrderFunctionType = "weighted")


scHOT_spatial@scHOT_output

scHOT_spatial <- scHOT_setPermutationScaffold(scHOT_spatial, 
                                              numberPermutations = 100)


scHOT_spatial@scHOT_output


scHOT_spatial <- scHOT_calculateHigherOrderTestStatistics(
  scHOT_spatial,
  higherOrderSummaryFunction = sd)

scHOT_spatial@scHOT_output


system.time(scHOT_spatial <- scHOT_performPermutationTest(
  scHOT_spatial, 
  verbose = TRUE,
  parallel = TRUE,
  BPPARAM = MulticoreParam(workers = 4)))


scHOT_spatial <- scHOT_estimatePvalues(scHOT_spatial)
scHOT_spatial@scHOT_output

ggplot(as.data.frame(scHOT_spatial@scHOT_output),
       aes(x = -log10(pvalPermutations), y = -log10(pvalEstimated))) + 
  geom_point() + 
  theme_classic() + 
  geom_abline(slope = 1, intercept = 0) +
  xlab("Permutation -log10(p-value)") +
  ylab("Estimated -log10(p-value)") +
  NULL

colData(scHOT_spatial)[, "-x"] <- -colData(scHOT_spatial)[, "x"]
plotHigherOrderSequence(scHOT_spatial, c("Dnm1l_Gucy1b3"),
                        positionColData = c("-x", "y"))

plotOrderedExpression(scHOT_spatial, c("Dnm1l", "Gucy1b3"),
                      positionColData = c("-x", "y"),
                      assayName = "expression")
```

## Perform scHOT using `scHOT` wrapper function

Please strip the scHOT output using `scHOT_stripOutput` before rerun scHOT. 
```{r}
scHOT_spatial <- scHOT_stripOutput(scHOT_spatial, force = TRUE)

scHOT_spatial
scHOT_spatial@scHOT_output
```


```{r}
scHOT_spatial <- scHOT(scHOT_spatial,
                       testingScaffold = pairs,
                       positionType = "spatial",
                       positionColData = c("x", "y"),
                       nrow.out = NULL,
                       higherOrderFunction = weightedSpearman,
                       higherOrderFunctionType = "weighted",
                       numberPermutations = 100,
                       higherOrderSummaryFunction = sd,
                       parallel = TRUE,
                       BPPARAM = MulticoreParam(workers = 4),
                       verbose = TRUE,
                       span = 0.05)

scHOT_spatial@scHOT_output

plotOrderedExpression(scHOT_spatial, c("Arrb1", "Mtor"),
                      positionColData = c("-x", "y"),
                      assayName = "expression")

plotHigherOrderSequence(scHOT_spatial, "Arrb1_Mtor",
                        positionColData = c("-x", "y"))
```


```{r}
sessionInfo()
```
